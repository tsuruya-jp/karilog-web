# Karilog Web 要件定義書

## 1. プロジェクト概要

### 1.1 サービス名
**Karilog Web（カリログ ウェブ）**

### 1.2 サービス概要
射撃および狩猟の帳簿をデジタル管理するWebアプリケーションのフロントエンド。
バックエンドAPI（karilog-api）と連携し、実包管理帳簿、出猟カレンダーなどの機能をユーザーフレンドリーなUIで提供する。

### 1.3 リポジトリ構成
- **バックエンド**: `karilog-api` (Rust + Axum)
- **フロントエンド**: `karilog-web` (SPA) ← 本プロジェクト

---

## 2. ターゲットユーザー

### 2.1 主要ユーザー層
- 個人の猟師
- 射撃選手
- 有害鳥獣駆除に従事する専門家

### 2.2 ユーザー特性
- PCまたはタブレットでの利用を想定
- デジタルツールに慣れていない層も含む
- 法的義務として帳簿を管理する必要がある

### 2.3 使用シーン
- **実包購入時**: 銃砲店で購入後、帰宅してから記録
- **実包使用時**: 射撃場や出猟から帰宅後に記録
- **警察提出時**: 定期的にPDF出力して提出
- **出猟計画時**: カレンダーで予定を確認・登録

---

## 3. 技術要件

### 3.1 技術スタック候補

#### React + Farm（推奨）
| 技術 | 選定理由 |
|------|----------|
| フレームワーク | React 19 + TypeScript | エコシステムが豊富、型安全性 |
| パッケージマネージャー | Bun | 超高速インストール＆実行 |
| ビルドツール | Farm | Rust製、ミリ秒単位起動、10ms以内HMR |
| 状態管理 | TanStack Query + Zustand | サーバー状態とクライアント状態の分離 |
| UIライブラリ | shadcn/ui | モダン、軽量、カスタマイズ可能 |
| フォーム管理 | react-hook-form + Zod | 宣言的、バリデーション統合 |
| ルーティング | TanStack Router | 型安全、データローディング内蔵 |
| カレンダー | FullCalendar | 出猟カレンダー表示に最適 |
| PDF表示 | react-pdf | PDF表示・ダウンロード |
| HTTP通信 | Axios | RESTful API連携 |
| 日付処理 | date-fns | 軽量、Tree-shakeable |

**備考**: APIサーバーが別途存在するため、SSR/SSGのメリットは限定的。純粋なSPAとしてはReact + Farmが最適。BunとFarmの組み合わせで最高速の開発体験を実現。

### 3.2 開発環境
- **Bunランタイム**: v1.0以上（Node.js不要）
- **パッケージマネージャー**: Bun
- **エディタ**: VS Code推奨
- **ブラウザ**: Chrome, Firefox, Safari最新版

---

## 4. 機能要件

### 4.1 コア機能（MVP）

#### 4.1.1 認証機能
| 機能 | 説明 | 優先度 |
|------|------|--------|
| ユーザー登録 | メールアドレス・パスワードで新規登録 | 高 |
| メール確認 | 登録時の確認メール処理 | 高 |
| ログイン | JWT認証によるログイン | 高 |
| ログアウト | セッション終了 | 高 |
| パスワードリセット | メールでリセットリンク送信 | 高 |
| 自動ログイン | リフレッシュトークンによる自動更新 | 高 |
| セッション管理 | トークン期限切れ時の再ログイン促進 | 高 |

#### 4.1.2 実包管理帳簿（最優先）
| 機能 | 説明 | 優先度 |
|------|------|--------|
| ダッシュボード | 実包在庫サマリー、直近の購入・使用記録 | 高 |
| 実包種別管理 | 種別の登録・一覧・編集・削除 | 高 |
| 購入記録管理 | 購入記録の登録・一覧・編集・削除 | 高 |
| 購入時上限チェック | 許可上限を超える場合の警告表示 | 高 |
| 使用記録管理 | 使用記録の登録・一覧・編集・削除 | 高 |
| 使用時在庫チェック | 在庫不足時のエラー表示 | 高 |
| 在庫一覧 | 実包種別ごとの在庫数・譲受可能残数表示 | 高 |
| 所持許可上限設定 | 口径ごとの上限設定 | 高 |
| 帳簿PDF出力 | 警察提出用PDF生成・ダウンロード | 高 |
| CSV出力 | 購入・使用履歴のCSVエクスポート | 中 |

#### 4.1.3 出猟管理（最優先）
| 機能 | 説明 | 優先度 |
|------|------|--------|
| 出猟カレンダー | 月次カレンダー表示（予定/実績の色分け） | 高 |
| 出猟記録登録 | カレンダーから直接登録・編集 | 高 |
| 出猟記録一覧 | リスト表示、フィルタリング（期間・場所） | 高 |
| 出猟統計 | 月別・年別の出猟回数、場所別集計 | 中 |
| 実包使用紐付け | 出猟記録と実包使用記録の連携 | 中 |

### 4.2 サポート機能

#### 4.2.1 銃砲管理
| 機能 | 説明 | 優先度 |
|------|------|--------|
| 銃砲一覧 | 登録済み銃砲の一覧表示 | 中 |
| 銃砲登録 | 新規銃砲の登録（銃種、名称、番号等） | 中 |
| 銃砲編集・削除 | 登録内容の変更・削除 | 中 |

#### 4.2.2 アカウント管理
| 機能 | 説明 | 優先度 |
|------|------|--------|
| アカウント情報表示 | ユーザー名、メールアドレス表示 | 中 |
| アカウント情報編集 | ユーザー名の変更 | 中 |
| パスワード変更 | 現在のパスワード確認後の変更 | 中 |
| アカウント削除 | 論理削除 | 低 |

### 4.3 UX要件

#### 4.3.1 レスポンシブデザイン
- デスクトップ（1920x1080以上）を優先
- タブレット（768px以上）対応
- スマートフォンは将来対応（モバイルアプリで代替予定）

#### 4.3.2 操作性
- 直感的なUI（専門用語は最小限）
- 入力項目は必要最小限
- バリデーションエラーは即座に表示
- 成功・エラーメッセージをトースト表示
- ローディング状態の明示

#### 4.3.3 アクセシビリティ
- キーボード操作対応
- スクリーンリーダー対応（aria属性）
- 色覚サポート（色だけに依存しない）

---

## 5. 非機能要件

### 5.1 パフォーマンス要件
| 項目 | 目標値 |
|------|--------|
| 初回ページ読み込み | 3秒以内 |
| ページ遷移 | 500ms以内 |
| API応答後のUI更新 | 100ms以内 |

### 5.2 セキュリティ要件
| 項目 | 要件 |
|------|------|
| 認証方式 | JWT（アクセストークン1時間、リフレッシュ30日） |
| トークン保存 | localStorage（将来的にhttpOnlyクッキー検討） |
| XSS対策 | 入力値のサニタイゼーション |
| CSRF対策 | APIサーバー側で実装 |
| HTTPS通信 | 本番環境では必須 |

### 5.3 ブラウザ対応
| ブラウザ | バージョン |
|----------|-----------|
| Chrome | 最新版 |
| Firefox | 最新版 |
| Safari | 最新版 |
| Edge | 最新版 |

### 5.4 エラーハンドリング
- ネットワークエラー時の再試行機能
- APIエラー時のユーザーフレンドリーなメッセージ表示
- 予期しないエラー時のエラーバウンダリ

---

## 6. 画面一覧

### 6.1 認証系
- [ ] ログイン画面 (`/login`)
- [ ] ユーザー登録画面 (`/register`)
- [ ] メール確認画面 (`/verify-email`)
- [ ] パスワードリセット要求画面 (`/forgot-password`)
- [ ] パスワードリセット画面 (`/reset-password`)

### 6.2 ダッシュボード
- [ ] ホーム画面 (`/`) - 実包在庫サマリー、直近の出猟予定

### 6.3 実包管理
- [ ] 実包種別一覧 (`/ammunition-types`)
- [ ] 実包種別登録/編集画面 (`/ammunition-types/new`, `/ammunition-types/:id/edit`)
- [ ] 購入記録一覧 (`/ammunition-purchases`)
- [ ] 購入記録登録/編集画面 (`/ammunition-purchases/new`, `/ammunition-purchases/:id/edit`)
- [ ] 使用記録一覧 (`/ammunition-usages`)
- [ ] 使用記録登録/編集画面 (`/ammunition-usages/new`, `/ammunition-usages/:id/edit`)
- [ ] 在庫一覧 (`/ammunition-stock`)
- [ ] 所持許可上限設定 (`/ammunition-limits`)

### 6.4 出猟管理
- [ ] 出猟カレンダー (`/hunting-calendar`)
- [ ] 出猟記録登録/編集モーダル（カレンダー内）
- [ ] 出猟記録一覧 (`/hunting-records`)
- [ ] 出猟統計 (`/hunting-statistics`)

### 6.5 帳簿出力
- [ ] 帳簿出力画面 (`/reports`) - 期間選択、PDF/CSVダウンロード

### 6.6 銃砲管理
- [ ] 銃砲一覧 (`/firearms`)
- [ ] 銃砲登録/編集画面 (`/firearms/new`, `/firearms/:id/edit`)

### 6.7 設定
- [ ] アカウント設定 (`/settings/account`)
- [ ] パスワード変更 (`/settings/password`)

---

## 7. API連携方針

### 7.1 APIエンドポイント
- **ベースURL**: `http://localhost:8080/api/v1`（開発環境）
- **本番URL**: `https://api.karilog.jp/api/v1`（予定）

### 7.2 認証フロー
1. ログイン成功時にアクセストークンとリフレッシュトークンを取得
2. アクセストークンをリクエストヘッダーに付与（`Authorization: Bearer <token>`）
3. アクセストークン期限切れ時、リフレッシュトークンで自動更新
4. リフレッシュトークン期限切れ時、ログイン画面へリダイレクト

### 7.3 エラーハンドリング
| HTTPステータス | 処理 |
|----------------|------|
| 401 Unauthorized | ログイン画面へリダイレクト |
| 403 Forbidden | アクセス権限エラー表示 |
| 404 Not Found | リソース不存在エラー表示 |
| 422 Unprocessable Entity | バリデーションエラー表示 |
| 423 Locked | アカウントロックメッセージ表示 |
| 500 Internal Server Error | サーバーエラー表示 |

---

## 8. 状態管理方針

### 8.1 サーバー状態（TanStack Query）
- API取得データのキャッシュ管理
- 自動リフェッチ、楽観的更新
- ローディング・エラー状態の管理

### 8.2 クライアント状態（Zustand）
- 認証状態（ユーザー情報、トークン）
- UIステート（モーダル開閉、サイドバー表示等）
- フォーム入力途中のデータ（必要に応じて）

---

## 9. ディレクトリ構成案

```
karilog-web/
├── public/                 # 静的ファイル
├── src/
│   ├── main.tsx            # エントリポイント
│   ├── App.tsx             # ルートコンポーネント
│   ├── pages/              # ページコンポーネント
│   │   ├── auth/           # 認証関連ページ
│   │   ├── dashboard/      # ダッシュボード
│   │   ├── ammunition/     # 実包管理
│   │   ├── hunting/        # 出猟管理
│   │   ├── firearms/       # 銃砲管理
│   │   └── settings/       # 設定
│   ├── components/         # 共通コンポーネント
│   │   ├── ui/             # UIコンポーネント（shadcn/ui等）
│   │   ├── layout/         # レイアウトコンポーネント
│   │   └── forms/          # フォームコンポーネント
│   ├── features/           # 機能別モジュール
│   │   ├── auth/           # 認証機能
│   │   ├── ammunition/     # 実包管理機能
│   │   └── hunting/        # 出猟管理機能
│   ├── hooks/              # カスタムフック
│   ├── api/                # API通信
│   │   ├── client.ts       # Axiosインスタンス
│   │   ├── auth.ts         # 認証API
│   │   ├── ammunition.ts   # 実包管理API
│   │   └── hunting.ts      # 出猟管理API
│   ├── stores/             # 状態管理（Zustand）
│   │   └── auth.ts         # 認証ストア
│   ├── types/              # 型定義
│   ├── utils/              # ユーティリティ関数
│   ├── styles/             # グローバルスタイル
│   └── routes/             # ルーティング設定（TanStack Router）
├── docs/                   # ドキュメント
│   ├── requirements.md     # 要件定義書（本ドキュメント）
│   ├── design.md           # 画面設計書
│   └── api-integration.md  # API連携仕様書
├── .env.example            # 環境変数サンプル
├── package.json
├── tsconfig.json
└── vite.config.ts
```

---

## 10. 開発優先順位

### Phase 1: 認証基盤（1-2週間）
1. プロジェクトセットアップ
2. ルーティング設定（TanStack Router、型安全なルート定義）
3. 認証API連携
4. ログイン・ログアウト画面
5. ユーザー登録・メール確認
6. パスワードリセット
7. トークン自動更新機能

### Phase 2: 実包管理帳簿（3-4週間）
1. ダッシュボード画面
2. 実包種別管理（CRUD）
3. 購入記録管理（CRUD、上限チェック）
4. 使用記録管理（CRUD、在庫チェック）
5. 在庫一覧画面
6. 所持許可上限設定
7. 帳簿PDF出力機能

### Phase 3: 出猟管理（2-3週間）
1. 出猟カレンダー画面（FullCalendar統合）
2. 出猟記録登録・編集（モーダルまたは別画面）
3. 出猟記録一覧・フィルタリング
4. 出猟統計画面
5. 実包使用記録との連携

### Phase 4: サポート機能（1-2週間）
1. 銃砲管理画面（CRUD）
2. アカウント設定画面
3. パスワード変更機能
4. CSV出力機能

### Phase 5: 最適化・テスト（1-2週間）
1. パフォーマンス最適化
2. アクセシビリティ改善
3. E2Eテスト
4. バグ修正

---

## 11. 将来的な拡張（対象外）

- PWA対応（オフライン機能）
- モバイルアプリ（React Native）
- 多言語対応（i18n）
- ダークモード
- 通知機能（期限切れアラート等）
- データ同期機能
- ソーシャルログイン（Google, Apple等）

---

## 12. 制約事項

### 12.1 開発体制
- 個人開発（1名）
- 納期設定なし

### 12.2 プラットフォーム
- 初期: Webアプリ（デスクトップ・タブレット優先）
- 後発: モバイルアプリ

### 12.3 依存関係
- バックエンドAPI（karilog-api）が実装済みであること
- APIのエンドポイントとレスポンス形式が確定していること

---

## 13. 参考ドキュメント

- [karilog-api 要件定義書](../../karilog-api/docs/requirements.md)
- [karilog-api API設計書](../../karilog-api/docs/api.md)
- [karilog-api Swagger仕様](../../karilog-api/docs/swagger.yml)

---

## 14. 改訂履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 1.2 | 2025-12-04 | パッケージマネージャーをBunに、ビルドツールをFarmに変更 |
| 1.1 | 2025-12-04 | ルーティングをReact Router v6からTanStack Routerに変更 |
| 1.0 | 2025-12-01 | 初版作成 |
